{% extends 'admin/base.html' %}
{% block title %}Логи — AI Router{% endblock %}
{% block content %}
<style>
  .preview-cell {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .preview-button {
    background: #40739e;
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 6px 12px;
    font-size: 13px;
    border-radius: 4px;
    transition: background 0.2s ease;
  }

  .preview-button:hover,
  .preview-button:focus {
    background: #305a7d;
    outline: none;
  }

  dialog {
    border: none;
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
    max-width: 640px;
    width: 90%;
    padding: 0;
  }

  dialog::backdrop {
    background: rgba(0, 0, 0, 0.45);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #ecf0f1;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 18px;
  }

  .modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
  }

  .modal-body pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: inherit;
    font-size: 14px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    color: #718093;
  }
</style>

<h2>Логи диалогов</h2>
<form class="filters" method="get">
  <div class="form-row">
    <label>Диалоги
      <input type="number" name="dialog_limit" min="1" value="{{ dialog_limit }}">
    </label>
    <label>Сообщения
      <input type="number" name="limit" min="1" value="{{ limit }}">
    </label>
    <button class="btn" type="submit">Показать</button>
  </div>
</form>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Название</th>
      <th>Сообщений</th>
      <th>Пользователь</th>
      <th>Расход токенов</th>
      <th>Статус</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody>
    {% for dialog in dialog_logs %}
    <tr>
      <td>{{ dialog.id }}</td>
      <td><span class="dialog-title" title="{{ dialog.full_title or 'Нет данных' }}">{{ dialog.title }}</span></td>
      <td>{{ dialog.message_count }}</td>
      <td>{{ dialog.username }}</td>
      <td>{{ dialog.tokens_spent }}</td>
      <td>{% if dialog.is_active %}Открыт{% else %}Закрыт{% endif %}</td>
      <td>
        {% if dialog.is_active %}
        <form class="inline" method="post" action="{{ url_for('admin.close_dialog', dialog_id=dialog.id) }}">
          <button class="btn secondary" type="submit">Закрыть</button>
        </form>
        {% else %}
        —
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Логи сообщений</h2>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Диалог</th>
      <th>Пользователь</th>
      <th>Сообщение</th>
      <th>Ответ</th>
      <th>Токены</th>
      <th>Время запроса</th>
    </tr>
  </thead>
  <tbody>
    {% for record in message_rows %}
    <tr>
      <td>{{ record.id }}</td>
      <td>{{ record.dialog_id }}</td>
      <td>{{ record.username }}</td>
      <td>
        <div class="preview-cell">
          <span>{{ record.user_message_preview }}</span>
          {% if record.user_message_truncated %}
          <button
            type="button"
            class="preview-button show-full-text"
            data-title="Сообщение пользователя #{{ record.id }}"
            data-full-text="{{ record.user_message_full | e }}"
          >Показать полностью</button>
          {% endif %}
        </div>
      </td>
      <td>
        <div class="preview-cell">
          <span>{{ record.llm_response_preview }}</span>
          {% if record.llm_response_truncated %}
          <button
            type="button"
            class="preview-button show-full-text"
            data-title="Ответ LLM #{{ record.id }}"
            data-full-text="{{ record.llm_response_full | e }}"
          >Показать полностью</button>
          {% endif %}
        </div>
      </td>
      <td>{{ record.tokens_used }}</td>
      <td>{{ record.created_at }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<dialog id="text-modal">
  <div class="modal-header">
    <h3 class="modal-title">Полный текст</h3>
    <button type="button" class="modal-close" data-close>&times;</button>
  </div>
  <div class="modal-body">
    <pre class="modal-content"></pre>
  </div>
</dialog>

<script>
  (function () {
    const modal = document.getElementById('text-modal');
    if (!modal) {
      return;
    }

    const titleEl = modal.querySelector('.modal-title');
    const contentEl = modal.querySelector('.modal-content');
    const closeBtn = modal.querySelector('[data-close]');

    const closeModal = () => {
      if (typeof modal.close === 'function') {
        modal.close();
      }
    };

    closeBtn.addEventListener('click', closeModal);

    modal.addEventListener('cancel', (event) => {
      event.preventDefault();
      closeModal();
    });

    document.querySelectorAll('.show-full-text').forEach((button) => {
      button.addEventListener('click', () => {
        const title = button.dataset.title || 'Полный текст';
        const fullText = button.dataset.fullText || '';
        if (titleEl) {
          titleEl.textContent = title;
        }
        if (contentEl) {
          contentEl.textContent = fullText;
        }
        if (typeof modal.showModal === 'function') {
          modal.showModal();
        }
      });
    });
  })();
</script>
{% endblock %}
