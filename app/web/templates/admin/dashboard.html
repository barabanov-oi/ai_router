{% extends 'admin/base.html' %}
{% block title %}Дашборд — AI Router{% endblock %}
{% block content %}
<h2>Дашборд</h2>
<form method="get" class="period-form">
  <label>Начало периода
    <input type="date" name="start_date" value="{{ start_date }}">
  </label>
  <label>Окончание периода
    <input type="date" name="end_date" value="{{ end_date }}">
  </label>
  <input type="hidden" name="days" value="{{ period_days }}">
  <div class="form-actions">
    <button class="btn" type="submit">Применить</button>
    <a class="btn secondary" href="{{ url_for('admin.dashboard') }}">Сбросить</a>
  </div>
</form>
{% if start_date and end_date %}
<p>Статистика с {{ start_date }} по {{ end_date }}.</p>
{% elif start_date %}
<p>Статистика с {{ start_date }}.</p>
{% elif end_date %}
<p>Статистика до {{ end_date }}.</p>
{% else %}
<p>Статистика за {{ period_days }} дней.</p>
{% endif %}
<div class="stats">
  <div class="stat-card"><strong>{{ stats.total_users }}</strong>Пользователи</div>
  <div class="stat-card"><strong>{{ stats.active_users }}</strong>Активные пользователи</div>
  <div class="stat-card"><strong>{{ stats.query_count }}</strong>Запросы</div>
  <div class="stat-card"><strong>{{ stats.tokens_spent }}</strong>Токены</div>
  <div class="stat-card"><strong>{{ stats.open_dialogs }}</strong>Открытые диалоги</div>
</div>
<h3>Статус бота</h3>
<p>Текущее состояние: {% if is_bot_running %}<strong style="color:green;">запущен</strong>{% else %}<strong style="color:red;">остановлен</strong>{% endif %}</p>
<form id="start-polling" class="inline" method="post" action="{{ url_for('admin.api_start_polling') }}" onsubmit="return sendApi(event);">
  <button class="btn" type="submit">Запустить polling</button>
</form>
<form id="start-webhook" class="inline" method="post" action="{{ url_for('admin.api_start_webhook') }}" onsubmit="return sendApi(event);">
  <button class="btn secondary" type="submit">Запустить webhook</button>
</form>
<form id="stop-bot" class="inline" method="post" action="{{ url_for('admin.api_stop_bot') }}" onsubmit="return sendApi(event);">
  <button class="btn danger" type="submit">Остановить бота</button>
</form>
<h3>Активная модель</h3>
{% if active_model %}
<div class="active-model">
  <span class="active-model-pill">{{ active_model.name }} — {{ active_model.model }}</span>
  {% if active_model.instruction %}
  <p class="active-model-note">Инструкция:</p>
  <div class="active-model-instruction">{{ active_model.instruction }}</div>
  {% endif %}
</div>
{% else %}
<p>Активная модель не выбрана.</p>
{% endif %}
<script>
async function sendApi(event) {
  event.preventDefault();
  const form = event.target;
  const response = await fetch(form.action, {method: 'POST', headers: {'Content-Type': 'application/json'}});
  const data = await response.json();
  if (data.status === 'ok') {
    alert('Операция выполнена');
    window.location.reload();
  } else {
    alert('Ошибка: ' + data.message);
  }
  return false;
}
</script>
{% endblock %}
