{% extends 'admin/base.html' %}
{% block title %}Модели — AI Router{% endblock %}
{% block content %}
<h2>Модели</h2>
{% if not providers %}
<div style="padding:12px 16px; background:#ffeaa7; border-radius:6px; margin-bottom:16px;">
  Добавьте хотя бы одного поставщика на странице «Поставщики», чтобы создавать конфигурации моделей.
</div>
{% endif %}
<h3>Список моделей</h3>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Название</th>
      <th>Поставщик</th>
      <th>Модель</th>
      <th>Temperature</th>
      <th>Max tokens</th>
      <th>Инструкция</th>
      <th>Активная</th>
    </tr>
  </thead>
  <tbody>
    {% for model in models %}
    <tr>
      <td>{{ model.id }}</td>
      <td>{{ model.name }}</td>
      <td>
        {% if model.provider %}
          <div>{{ model.provider.name }}</div>
          <div style="font-size:12px; color:#718093;">{{ provider_titles.get(model.provider.vendor, model.provider.vendor) }}</div>
        {% else %}
          —
        {% endif %}
      </td>
      <td>{{ model.model }}</td>
      <td>{{ model.temperature }}</td>
      <td>{{ model.max_tokens }}</td>
      <td>
        {% if model.system_instruction %}
          {{ model.system_instruction[:40] ~ ('…' if model.system_instruction|length > 40 else '') }}
        {% else %}
          —
        {% endif %}
      </td>

      <td>{% if active_model_id == model.id|string %}Да{% elif not active_model_id and model.is_default %}Да{% else %}Нет{% endif %}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<h3>Редактирование моделей</h3>
{% if models %}
  {% for model in models %}
  <details class="model-editor">
    <summary>{{ model.name }} — {{ model.model }}</summary>
    <form method="post">
      <input type="hidden" name="action" value="update">
      <input type="hidden" name="model_id" value="{{ model.id }}">
      <label>Название
        <input type="text" name="name" value="{{ model.name }}" required>
      </label>
      <label>Идентификатор модели
        <input type="text" name="model" value="{{ model.model }}" required>
      </label>
      <label>Поставщик
        <select name="provider_id" required>
          {% for provider in providers %}
          <option value="{{ provider.id }}" {% if provider.id == model.provider_id %}selected{% endif %}>
            {{ provider.name }} — {{ provider_titles.get(provider.vendor, provider.vendor) }}
          </option>
          {% endfor %}
        </select>
      </label>
      <label>Temperature
        <input type="number" step="0.1" name="temperature" value="{{ model.temperature }}">
      </label>
      <label>Max tokens
        <input type="number" name="max_tokens" value="{{ model.max_tokens }}">
      </label>
      <label>Top P
        <input type="number" step="0.1" name="top_p" value="{{ model.top_p }}">
      </label>
      <label>Инструкция
        <textarea name="system_instruction">{{ model.system_instruction or '' }}</textarea>
      </label>
      <label>
        <input type="checkbox" name="is_default" {% if active_model_id == model.id|string or (not active_model_id and model.is_default) %}checked{% endif %}> Сделать модель активной
      </label>
      <button class="btn" type="submit">Сохранить изменения</button>
    </form>
  </details>
  {% endfor %}
{% else %}
<p>Конфигурации ещё не созданы.</p>
{% endif %}
{% if providers %}
<form method="post" class="model-form">
  <input type="hidden" name="action" value="create">
  <h3>Новая конфигурация</h3>
  <label>Название
    <input type="text" name="name" required>
  </label>
  <label>Идентификатор модели
    <input type="text" name="model" required>
  </label>
  <label>Поставщик
    <select name="provider_id" required>
      <option value="" disabled selected>-- выберите поставщика --</option>
      {% for provider in providers %}
      <option value="{{ provider.id }}">{{ provider.name }} — {{ provider_titles.get(provider.vendor, provider.vendor) }}</option>
      {% endfor %}
    </select>
  </label>
  <label>Temperature
    <input type="number" step="0.1" name="temperature" value="1.0">
  </label>
  <label>Max tokens
    <input type="number" name="max_tokens" value="512">
  </label>
  <label>Top P
    <input type="number" step="0.1" name="top_p" value="1.0">
  </label>
  <label>Инструкция
    <textarea name="system_instruction" placeholder="Системный промпт для модели"></textarea>
  </label>
  <label>
    <input type="checkbox" name="is_default"> Сделать модель активной
  </label>
  <button class="btn" type="submit">Добавить</button>
</form>
{% endif %}
{% endblock %}
