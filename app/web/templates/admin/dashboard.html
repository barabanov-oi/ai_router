{% extends 'admin/base.html' %}
{% block title %}Дашборд — AI Router{% endblock %}
{% block content %}
<h2>Дашборд</h2>
<form class="filters" method="get">
  <div class="form-row">
    <label>Начало периода
      <input type="date" name="start" value="{{ start_value }}">
    </label>
    <label>Конец периода
      <input type="date" name="end" value="{{ end_value }}">
    </label>
    <label>Количество дней
      <input type="number" name="days" min="1" value="{{ period }}">
    </label>
    <button class="btn" type="submit">Обновить</button>
  </div>
</form>
{% if start_date and end_date %}
<p>Статистика за период с {{ start_date.strftime('%d.%m.%Y') }} по {{ end_date.strftime('%d.%m.%Y') }} ({{ selected_period_days }} дн.).</p>
{% else %}
<p>Статистика за {{ period }} дней.</p>
{% endif %}
<div class="stats">
  <div class="stat-card"><strong>{{ stats.total_users }}</strong>Пользователи</div>
  <div class="stat-card"><strong>{{ stats.active_users }}</strong>Активные пользователи</div>
  <div class="stat-card"><strong>{{ stats.query_count }}</strong>Запросы</div>
  <div class="stat-card"><strong>{{ stats.tokens_spent }}</strong>Токены</div>
  <div class="stat-card"><strong>{{ stats.open_dialogs }}</strong>Открытые диалоги</div>
</div>
<h3>Статус бота</h3>
<p>Текущее состояние: {% if is_bot_running %}<strong style="color:green;">запущен</strong>{% else %}<strong style="color:red;">остановлен</strong>{% endif %}</p>
<form id="start-polling" class="inline" method="post" action="{{ url_for('admin.api_start_polling') }}" onsubmit="return sendApi(event);">
  <button class="btn" type="submit">Запустить polling</button>
</form>
<form id="start-webhook" class="inline" method="post" action="{{ url_for('admin.api_start_webhook') }}" onsubmit="return sendApi(event);">
  <button class="btn secondary" type="submit">Запустить webhook</button>
</form>
<form id="stop-bot" class="inline" method="post" action="{{ url_for('admin.api_stop_bot') }}" onsubmit="return sendApi(event);">
  <button class="btn danger" type="submit">Остановить бота</button>
</form>
<h3>Активная модель</h3>
{% if active_model %}
<div class="active-model-badge" title="{{ active_model.model }}">
  <span class="badge-name">{{ active_model.name }}</span>
  <span class="badge-subtitle">{{ active_model.model }}</span>
  {% if active_model.provider %}
  <span class="badge-subtitle">{{ provider_titles.get(active_model.provider.vendor, active_model.provider.vendor) }} — {{ active_model.provider.name }}</span>
  {% endif %}
</div>
{% else %}
<p>Активная модель не выбрана.</p>
{% endif %}
<script>
async function sendApi(event) {
  event.preventDefault();
  const form = event.target;
  const response = await fetch(form.action, {method: 'POST', headers: {'Content-Type': 'application/json'}});
  const data = await response.json();
  if (data.status === 'ok') {
    alert('Операция выполнена');
    window.location.reload();
  } else {
    alert('Ошибка: ' + data.message);
  }
  return false;
}
</script>
{% endblock %}
