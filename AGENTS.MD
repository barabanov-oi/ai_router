# Обзор проекта ai_router

Приложение на **Python/Flask** для доступа к LLM через API различных AI-сервисов.  
Состоит из:
- **Телеграм-бота** — основной пользовательский интерфейс для общения с моделью.
- **Веб-интерфейса администратора** — панель управления и мониторинга.
- Общих сервисов и моделей данных.

В приложении заложена логика работы с несколькими поставщиками LLM через API (OpenAI, Google, Groq и др.) и возможностью добавления новых.
Реализована возможность добавления новых поставщиков и моделей с разными параметрами генерации.

## Структура проекта
```
ai_router/
├── run.py
└── app/
    ├── __init__.py
    ├── bot/
    │   ├── bot_modes.py
    │   ├── bot_service.py
    │   ├── dialog_management.py
    │   └── message_handlers.py
    ├── models/
    │   ├── __init__.py
    │   ├── user.py
    │   ├── dialog.py
    │   ├── message.py
    │   ├── model_config.py
    │   ├── provider.py
    │   └── setting.py
    ├── services/
    │   ├── llm_service.py
    │   ├── settings_service.py
    │   ├── statistics_service.py
    │   └── providers/
    │       ├── base.py
    │       ├── openai_provider.py
    │       ├── google_provider.py
    │       ├── groq_provider.py
    │       └── openai_model_params.json
    └── web/
        ├── __init__.py
        ├── admin/__init__.py
        └── templates/admin/…

```

### `web/` — логика веб-интерфейса администратора (Flask Blueprints, роуты, шаблоны).
- Пакет `app.web` экспортирует административный blueprint для подключения к приложению.
- Маршрут дашборда собирает статистику, состояние бота и активную модель, выводя их в шаблон админки.
- Разделы `/users` и `/logs` позволяют управлять активностью пользователей и просматривать аггрегированные диалоги/сообщения с укороченными превью и статистикой токенов.
- Эндпоинты `/providers`, `/models` и `/settings` управляют поставщиками, конфигурациями моделей и глобальными настройками, включая выбор модели по умолчанию и сохранение ключей.
- JSON API и служебные маршруты запуска/остановки `polling`, настройки `webhook` и закрытия диалогов обеспечивают удалённое администрирование бота.

### `bot/` — функционал телеграм-бота (обработчики команд, клавиатуры, сценарии диалога).
- `__init__.py`: объявляет пакет бота и реэкспортирует TelegramBotManager для удобного подключения.
- `bot_service.py`: реализует TelegramBotManager, объединяющий миксины жизненного цикла, обработки сообщений и управления диалогами; отвечает за запуск/остановку polling и webhook, создание TeleBot, проксирование webhook-апдейтов и ведёт контекст Flask в потоках.
- `message_handlers.py`: регистрирует обработчики команд, callback-кнопок и текстовых сообщений; управляет созданием диалогов, ведением логов, отправкой ответов (включая разбиение на части, клавиатуры и индикатор набора), а также обработкой ошибок при обращении к LLM.
- `dialog_management.py`: предоставляет утилиты для работы с пользователями и диалогами, сборки истории сообщений для LLM, выбора конфигурации модели, подсчёта токенов и построения inline-клавиатур истории.
- `bot_modes.py`: описывает доступные режимы ответа с заголовками, системными инструкциями и параметрами генерации.

### `services/` — универсальные модули (работа с API, утилиты, бизнес-логика).
- `llm_service.py`: управляет выбором провайдера для чат-запроса, кеширует клиентов и делегирует им отправку запросов и разбор ответов, проверяя наличие ключей и поддерживаемых вендоров.
- `settings_service.py`: инкапсулирует чтение и запись настроек приложения в AppSetting, возвращая значения с логированием пропусков и сбором полного словаря.
- `statistics_service.py`: агрегирует метрики за период (пользователи, активность, токены, открытые диалоги) по данным моделей User, Dialog и MessageLog.
- `providers/__init__.py`: обозначает подмодуль клиентов внешних провайдеров.
- `providers/base.py`: задаёт абстрактный интерфейс клиента LLM с методами отправки запроса и извлечения ответа, проверяя наличие API-ключа.
- `providers/openai_provider.py`: реализует клиент OpenAI Chat Completions — нормализует параметры модели по правилам из `openai_model_params.json`, выполняет запросы, разбирает usage и очищает `<think>` блоки в ответах.
- `providers/google_provider.py`: заглушка для интеграции с Google AI, явно поднимает исключение при вызовах.
- `providers/groq_provider.py`: заглушка для Groq, аналогично `google_provider.py` сообщает об отсутствии реализации.

### `models/` — ORM-модели SQLAlchemy.
- `__init__.py`: настраивает SQLAlchemy с единым metadata и реэкспортирует основные модели.
- `user.py`: описывает модель Telegram-пользователя с атрибутами доступа, режимами и методами обновления активности.
- `dialog.py`: хранит состояние диалога (заголовок, статус, метки времени, chat_id) и предоставляет метод закрытия.
- `message.py`: фиксирует сообщения диалога, ответы LLM, расходы токенов и ссылки на отправленные сообщения, а метод register_response сохраняет данные ответа.
- `model_config.py`: хранит конфигурации LLM (параметры генерации, лимиты, инструкцию) и формирует словари настроек для запросов.
- `provider.py`: описывает поставщиков LLM, их API-ключи, поддерживаемые вендоры и обновление реквизитов.
- `setting.py`: реализует модель key/value для глобальных настроек с обновлением времени изменения.

## Функционал

### Веб-интерфейс администратора (web/)
- url-path для админки: `/admin`
- Мониторинг пользователей (просмотр активности, обращения к боту и ответы, расход токенов, диалоги).
- Настройки интеграции с различными провайдерами API LLM и моделей (API-ключи, параметры моделей). Возможность добавить несколько провайдеров и моделей, и переключаться между ними.
- Просмотр логов запросов и ответов пользователей, а также суммарной статистики по дилогам и сообщениям.
- Управление глобальными настройками приложения (например, модель по умолчанию, лимиты на запросы).
- Простая система статистики с выбором периода: кол-во запросов, активные пользователи, расход токенов.
- Указание API ключа телеграм-бота в настройках админки.
- Запуск телеграм-бота из админки в pooling (кнопка "Запустить бота") и webhook (кнопка "Запустить бота в webhook") режимах, а также остановка (кнопка "Остановить бота").

### Телеграм-бот (bot/)
- Отправка запросов к LLM через OpenAI API.
- Поддержка базовых команд (/start, /help).
- Поддержка диалогового режима: бот запоминает контекст переписки в рамках диалога, который прекращается кнопкой `Начать новый диалог` в inline-клавиатуре.
- Возможность управления подписками (free/paid) — планируется на будущее.
- Все обращения к боту логируются в БД с привязкой к пользователю и диалогу.

## Технологии и зависимости
- Flask — веб-фреймворк.
- SQLAlchemy — ORM для работы с БД.
- Requests — HTTP-запросы.
- Библиотеки для работы с провайдерами API LLM.
- Telebot (pyTelegramBotAPI) — работа с Telegram Bot API.

## Запуск проекта
flask run

## Стандарты разработки
- Следовать PEP8.
- Для всех функций — подробные docstrings (описание назначения, аргументов и возвращаемых значений).
- Использовать logging вместо print.
- SQLAlchemy модели определяются в папке models/.
- Общую бизнес-логику выносить в `services/`, избегать дублирования кода.
- Сложный функционал выностиь в отдельные модули в соответствующих разделах текущей структуры (`bot/`, `web/`, `services/`)

## Хранилище данных
- Простая SQL-база (например, SQLite) на этапе разработки.

## Дополнительно
- Минимизировать глобальные переменные.
- Все новые функции должны сопровождаться комментариями для агентов.
- В админке предусмотреть API-эндпоинты для управления настройками.
- В боте предусмотреть graceful handling ошибок (например, при недоступности OpenAI API).
- **Разбивай большие файлы на несколько логичных модулей с понятной структурой**, сохраняй поведение и совместимость, обновляй импорты
- При отправке сообщений ботом `send_message` форматируй текст с помощью `parse_mode='HTML`
- Для переноса строк в сообщениях используй `\n`, исключай сборку сообщений через `text_lines` и `"\n".join(text_lines)`
